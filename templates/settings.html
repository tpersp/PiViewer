<!DOCTYPE html>
<html>
<head>
  <title>Settings</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script>
    function toggleMainIP(){
      let roleSelect = document.getElementById("roleSelect");
      let mainIPField = document.getElementById("mainIPField");
      if(roleSelect.value === "sub"){
        mainIPField.style.display = "";
      } else {
        mainIPField.style.display = "none";
      }
    }
  </script>
</head>
<body class="{{ theme }}">
<div class="container">
  <h1>Settings</h1>

  <!-- ============== General Settings Form ============== -->
  <form method="POST" enctype="multipart/form-data">
    <!-- Hidden action indicates normal settings save -->
    <input type="hidden" name="action" value="">

    <label>Role:</label><br>
    <select name="role" id="roleSelect" onchange="toggleMainIP()">
      <option value="main" {% if cfg.role=="main" %}selected{% endif %}>main</option>
      <option value="sub" {% if cfg.role=="sub" %}selected{% endif %}>sub</option>
    </select>
    <br><br>

    <div id="mainIPField" {% if cfg.role!="sub" %}style="display:none;"{% endif %}>
      <label>Main Device IP:</label><br>
      <input type="text" name="main_ip" value="{{ cfg.main_ip }}">
      <br><br>
    </div>

    <label>Theme:</label><br>
    <select name="theme">
      <option value="dark"   {% if cfg.theme=="dark"   %}selected{% endif %}>Dark</option>
      <option value="light"  {% if cfg.theme=="light"  %}selected{% endif %}>Light</option>
      <option value="custom" {% if cfg.theme=="custom" %}selected{% endif %}>Custom</option>
    </select>
    <br><br>

    {% if cfg.theme=="custom" %}
    <label>Upload Custom BG:</label><br>
    <input type="file" name="bg_image" accept="image/*"><br><br>
    {% endif %}

    <!-- New GUI Settings Fieldset -->
    <fieldset style="border:1px solid #444; padding:10px; margin:20px 0;">
      <legend style="font-weight:bold;">GUI Settings</legend>
      <label>Background Blur Radius:</label><br>
      <input type="number" name="background_blur_radius" value="{{ cfg.gui.background_blur_radius|default('20') }}" min="0">
      <br><br>

      <!-- Using a percentage-based scale input -->
      <label>Background Resolution Scale (%):</label><br>
      <input type="number" name="background_scale_percent"
             value="{{ cfg.gui.background_scale_percent|default('100') }}"
             step="1" min="1" max="100">
      <br><br>

      <label>Foreground Resolution Scale (%):</label><br>
      <input type="number" name="foreground_scale_percent"
             value="{{ cfg.gui.foreground_scale_percent|default('100') }}"
             step="1" min="1" max="100">
    </fieldset>

    <!-- Weather Settings Fieldset -->
    <fieldset style="border:1px solid #444; padding:10px; margin:20px 0;">
      <legend style="font-weight:bold;">Weather Settings</legend>

      <label>OpenWeatherMap API Key:</label><br>
      <input type="text" name="weather_api_key"
             value="{{ cfg.weather.api_key|default('') }}"
             style="width:300px;">
      <br><br>

      <label>Zip Code:</label><br>
      <input type="text" name="weather_zip_code"
             value="{{ cfg.weather.zip_code|default('') }}">
      <br><br>

      <label>Country Code (2-letter, e.g. US):</label><br>
      <input type="text" name="weather_country_code"
             value="{{ cfg.weather.country_code|default('') }}">
      <br><br>

      <label>Latitude:</label><br>
      <input type="text" name="weather_lat"
             value="{{ cfg.weather.lat|default('') }}">
      <br><br>

      <label>Longitude:</label><br>
      <input type="text" name="weather_lon"
             value="{{ cfg.weather.lon|default('') }}">
      <br>
    </fieldset>

    <button type="submit">Save Settings</button>
  </form>
  <br>
  <hr>

  <!-- ============== Resolution Settings ============== -->
  <h2>Display Resolution Settings</h2>
  <p>Choose a resolution for each connected display. Upon pressing the button below, the device will reboot.</p>
  <form method="POST">
    <input type="hidden" name="action" value="apply_resolutions">

    <table style="border-collapse:collapse; margin-bottom:15px;">
      <thead>
        <tr>
          <th style="padding:5px; border-bottom:1px solid #ccc;">Monitor Name</th>
          <th style="padding:5px; border-bottom:1px solid #ccc;">Available Modes</th>
        </tr>
      </thead>
      <tbody>
      {% for mon_name, mdict in ext_mons.items() %}
        <tr>
          <td style="padding:5px; border-right:1px solid #ccc;">
            <strong>{{ mon_name }}</strong>
            {% if mdict.model %}
              <div style="font-size:0.85em; color:#aaa;">({{ mdict.model }})</div>
            {% endif %}
          </td>
          <td style="padding:5px;">
            <select name="res_{{ mon_name }}">
            {% for mode_val in mdict.modes %}
              {% set is_sel = (mode_val == mdict.current_mode) %}
              <option value="{{ mode_val }}" {% if is_sel %}selected{% endif %}>{{ mode_val }}</option>
            {% endfor %}
            </select>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>

    <button type="submit">Apply All Resolution Settings (Reboot)</button>
  </form>

  <br>
  <hr>

  <!-- Update Section -->
  <form method="POST" action="{{ url_for('main.update_app') }}">
    <p><strong>Update from GitHub:</strong></p>
    <p>
      Branch: <em>{{ update_branch }}</em>  
      (Configured in <code>config.py</code>)
    </p>
    <button type="submit">Update Now</button>
  </form>
  <hr>
  <br>

  <a href="{{ url_for('main.download_log') }}"><button>Download Log</button></a>
  <br><br>
  <a href="{{ url_for('main.index') }}"><button>Back to Main</button></a>
</div>
<script>toggleMainIP();</script>
</body>
</html>
